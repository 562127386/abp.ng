import { createSelector } from '@ngxs/store';
import { pipe, zip } from 'rxjs';
import { filter, map, switchMap, take } from 'rxjs/operators';
import { EntityProp } from '../models/entity-props';
import { FormProp } from '../models/form-props';
import { createEnum, createEnumOptions, createEnumValueResolver } from './enum.util';
import { createDisplayNameLocalizationPipeKeyGenerator } from './localization.util';
import { createExtraPropertyValueResolver } from './props.util';
import { getValidatorsFromProperty } from './validation.util';
const selectConfig = (state) => state.ConfigState;
const ɵ0 = selectConfig;
const ɵ1 = (config) => config.objectExtensions;
const selectObjectExtensions = createSelector([selectConfig], ɵ1);
const ɵ2 = (config) => config.localization;
const selectLocalization = createSelector([selectConfig], ɵ2);
const ɵ3 = (extensions) => Object.keys(extensions.enums).reduce((acc, key) => {
    const { fields, localizationResource } = extensions.enums[key];
    acc[key] = {
        fields,
        localizationResource,
        transformed: createEnum(fields),
    };
    return acc;
}, {});
const selectEnums = createSelector([selectObjectExtensions, selectLocalization], ɵ3);
const createObjectExtensionEntitiesSelector = (moduleKey) => createSelector([selectObjectExtensions], (extensions) => {
    if (!extensions)
        return null;
    return (extensions.modules[moduleKey] || {}).entities;
});
const ɵ4 = createObjectExtensionEntitiesSelector;
export function getObjectExtensionEntitiesFromStore(store, moduleKey) {
    return store.select(createObjectExtensionEntitiesSelector(moduleKey)).pipe(map(entities => (isUndefined(entities) ? {} : entities)), filter(Boolean), take(1));
}
export function mapEntitiesToContributors(store, resource) {
    return pipe(switchMap(entities => zip(store.select(selectLocalization), store.select(selectEnums)).pipe(map(([localization, enums]) => {
        const generateDisplayName = createDisplayNameLocalizationPipeKeyGenerator(localization);
        return Object.keys(entities).reduce((acc, key) => {
            acc.prop[key] = [];
            acc.createForm[key] = [];
            acc.editForm[key] = [];
            const entity = entities[key];
            if (!entity)
                return acc;
            const properties = entity.properties;
            if (!properties)
                return acc;
            const mapPropertiesToContributors = createPropertiesToContributorsMapper(generateDisplayName, resource, enums);
            return mapPropertiesToContributors(properties, acc, key);
        }, {
            prop: {},
            createForm: {},
            editForm: {},
        });
    }))), take(1));
}
function createPropertiesToContributorsMapper(generateDisplayName, resource, enums) {
    return (properties, contributors, key) => {
        const isExtra = true;
        Object.keys(properties).forEach((name) => {
            const property = properties[name];
            const type = getTypeFromProperty(property);
            const displayName = generateDisplayName(property.displayName, { name, resource });
            if (property.ui.onTable.isVisible) {
                const sortable = Boolean(property.ui.onTable.isSortable);
                const columnWidth = type === "boolean" /* Boolean */ ? 150 : 250;
                const valueResolver = type === "enum" /* Enum */
                    ? createEnumValueResolver(property.type, enums[property.type], name)
                    : createExtraPropertyValueResolver(name);
                const entityProp = new EntityProp({
                    type,
                    name,
                    displayName,
                    sortable,
                    columnWidth,
                    valueResolver,
                    isExtra,
                });
                const contributor = (propList) => propList.addTail(entityProp);
                contributors.prop[key].push(contributor);
            }
            const isOnCreateForm = property.ui.onCreateForm.isVisible;
            const isOnEditForm = property.ui.onEditForm.isVisible;
            if (isOnCreateForm || isOnEditForm) {
                const defaultValue = property.defaultValue;
                const validators = () => getValidatorsFromProperty(property);
                let options;
                if (type === "enum" /* Enum */)
                    options = createEnumOptions(name, enums[property.type]);
                const formProp = new FormProp({
                    type,
                    name,
                    displayName,
                    options,
                    defaultValue,
                    validators,
                    isExtra,
                });
                const formContributor = (propList) => propList.addTail(formProp);
                if (isOnCreateForm)
                    contributors.createForm[key].push(formContributor);
                if (isOnEditForm)
                    contributors.editForm[key].push(formContributor);
            }
        });
        return contributors;
    };
}
function getTypeFromProperty(property) {
    return property.typeSimple.replace(/\?$/, '');
}
function isUndefined(obj) {
    return typeof obj === 'undefined';
}
export { ɵ0, ɵ1, ɵ2, ɵ3, ɵ4 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUudXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL3RoZW1lLXNoYXJlZC9leHRlbnNpb25zL3NyYy9saWIvdXRpbHMvc3RhdGUudXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsY0FBYyxFQUFTLE1BQU0sYUFBYSxDQUFDO0FBQ3BELE9BQU8sRUFBYyxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU5RCxPQUFPLEVBQUUsVUFBVSxFQUFrQixNQUFNLHdCQUF3QixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxRQUFRLEVBQWdCLE1BQU0sc0JBQXNCLENBQUM7QUFHOUQsT0FBTyxFQUFFLFVBQVUsRUFBRSxpQkFBaUIsRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNyRixPQUFPLEVBQUUsNkNBQTZDLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNwRixPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDaEUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFOUQsTUFBTSxZQUFZLEdBQUcsQ0FBQyxLQUFVLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUM7O1dBSXJELENBQUMsTUFBK0IsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLGdCQUFnQjtBQUY5RCxNQUFNLHNCQUFzQixHQUFHLGNBQWMsQ0FDM0MsQ0FBQyxZQUFZLENBQUMsS0FFZixDQUFDO1dBSUEsQ0FBQyxNQUF5QyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsWUFBWTtBQUZwRSxNQUFNLGtCQUFrQixHQUFHLGNBQWMsQ0FDdkMsQ0FBQyxZQUFZLENBQUMsS0FFZixDQUFDO1dB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QztnQkFFbEYsSUFBSSxjQUFjO29CQUFFLFlBQVksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO2dCQUN2RSxJQUFJLFlBQVk7b0JBQUUsWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7YUFDcEU7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLFFBQW1DO0lBQzlELE9BQVEsUUFBUSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBeUIsQ0FBQztBQUN6RSxDQUFDO0FBRUQsU0FBUyxXQUFXLENBQUMsR0FBUTtJQUMzQixPQUFPLE9BQU8sR0FBRyxLQUFLLFdBQVcsQ0FBQztBQUNwQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQUJQLCBBcHBsaWNhdGlvbkNvbmZpZ3VyYXRpb24gfSBmcm9tICdAYWJwL25nLmNvcmUnO1xyXG5pbXBvcnQgeyBjcmVhdGVTZWxlY3RvciwgU3RvcmUgfSBmcm9tICdAbmd4cy9zdG9yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIHBpcGUsIHppcCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCwgc3dpdGNoTWFwLCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBlUHJvcFR5cGUgfSBmcm9tICcuLi9lbnVtcy9wcm9wcy5lbnVtJztcclxuaW1wb3J0IHsgRW50aXR5UHJvcCwgRW50aXR5UHJvcExpc3QgfSBmcm9tICcuLi9tb2RlbHMvZW50aXR5LXByb3BzJztcclxuaW1wb3J0IHsgRm9ybVByb3AsIEZvcm1Qcm9wTGlzdCB9IGZyb20gJy4uL21vZGVscy9mb3JtLXByb3BzJztcclxuaW1wb3J0IHsgT2JqZWN0RXh0ZW5zaW9ucyB9IGZyb20gJy4uL21vZGVscy9vYmplY3QtZXh0ZW5zaW9ucyc7XHJcbmltcG9ydCB7IFByb3BDYWxsYmFjayB9IGZyb20gJy4uL21vZGVscy9wcm9wcyc7XHJcbmltcG9ydCB7IGNyZWF0ZUVudW0sIGNyZWF0ZUVudW1PcHRpb25zLCBjcmVhdGVFbnVtVmFsdWVSZXNvbHZlciB9IGZyb20gJy4vZW51bS51dGlsJztcclxuaW1wb3J0IHsgY3JlYXRlRGlzcGxheU5hbWVMb2NhbGl6YXRpb25QaXBlS2V5R2VuZXJhdG9yIH0gZnJvbSAnLi9sb2NhbGl6YXRpb24udXRpbCc7XHJcbmltcG9ydCB7IGNyZWF0ZUV4dHJhUHJvcGVydHlWYWx1ZVJlc29sdmVyIH0gZnJvbSAnLi9wcm9wcy51dGlsJztcclxuaW1wb3J0IHsgZ2V0VmFsaWRhdG9yc0Zyb21Qcm9wZXJ0eSB9IGZyb20gJy4vdmFsaWRhdGlvbi51dGlsJztcclxuXHJcbmNvbnN0IHNlbGVjdENvbmZpZyA9IChzdGF0ZTogYW55KSA9PiBzdGF0ZS5Db25maWdTdGF0ZTtcclxuXHJcbmNvbnN0IHNlbGVjdE9iamVjdEV4dGVuc2lvbnMgPSBjcmVhdGVTZWxlY3RvcihcclxuICBbc2VsZWN0Q29uZmlnXSxcclxuICAoY29uZmlnOiBPYmplY3RFeHRlbnNpb25zLkNvbmZpZykgPT4gY29uZmlnLm9iamVjdEV4dGVuc2lvbnMsXHJcbik7XHJcblxyXG5jb25zdCBzZWxlY3RMb2NhbGl6YXRpb24gPSBjcmVhdGVTZWxlY3RvcihcclxuICBbc2VsZWN0Q29uZmlnXSxcclxuICAoY29uZmlnOiBBcHBsaWNhdGlvbkNvbmZpZ3VyYXRpb24uUmVzcG9uc2UpID0+IGNvbmZpZy5sb2NhbGl6YXRpb24sXHJcbik7XHJcblxyXG5jb25zdCBzZWxlY3RFbnVtcyA9IGNyZWF0ZVNlbGVjdG9yKFxyXG4gIFtzZWxlY3RPYmplY3RFeHRlbnNpb25zLCBzZWxlY3RMb2NhbGl6YXRpb25dLFxyXG4gIChleHRlbnNpb25zOiBPYmplY3RFeHRlbnNpb25zLkl0ZW0pID0+XHJcbiAgICBPYmplY3Qua2V5cyhleHRlbnNpb25zLmVudW1zKS5yZWR1Y2UoKGFjYywga2V5KSA9PiB7XHJcbiAgICAgIGNvbnN0IHsgZmllbGRzLCBsb2NhbGl6YXRpb25SZXNvdXJjZSB9ID0gZXh0ZW5zaW9ucy5lbnVtc1trZXldO1xyXG4gICAgICBhY2Nba2V5XSA9IHtcclxuICAgICAgICBmaWVsZHMsXHJcbiAgICAgICAgbG9jYWxpemF0aW9uUmVzb3VyY2UsXHJcbiAgICAgICAgdHJhbnNmb3JtZWQ6IGNyZWF0ZUVudW0oZmllbGRzKSxcclxuICAgICAgfTtcclxuICAgICAgcmV0dXJuIGFjYztcclxuICAgIH0sIHt9IGFzIE9iamVjdEV4dGVuc2lvbnMuRW51bXMpLFxyXG4pO1xyXG5cclxuY29uc3QgY3JlYXRlT2JqZWN0RXh0ZW5zaW9uRW50aXRpZXNTZWxlY3RvciA9IChtb2R1bGVLZXk6IE1vZHVsZUtleSkgPT5cclxuICBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0T2JqZWN0RXh0ZW5zaW9uc10sIChleHRlbnNpb25zOiBPYmplY3RFeHRlbnNpb25zLkl0ZW0pID0+IHtcclxuICAgIGlmICghZXh0ZW5zaW9ucykgcmV0dXJuIG51bGw7XHJcblxyXG4gICAgcmV0dXJuIChleHRlbnNpb25zLm1vZHVsZXNbbW9kdWxlS2V5XSB8fCAoe30gYXMgT2JqZWN0RXh0ZW5zaW9ucy5Nb2R1bGUpKS5lbnRpdGllcztcclxuICB9KTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRPYmplY3RFeHRlbnNpb25FbnRpdGllc0Zyb21TdG9yZShzdG9yZTogU3RvcmUsIG1vZHVsZUtleTogTW9kdWxlS2V5KSB7XHJcbiAgcmV0dXJuIHN0b3JlLnNlbGVjdChjcmVhdGVPYmplY3RFeHRlbnNpb25FbnRpdGllc1NlbGVjdG9yKG1vZHVsZUtleSkpLnBpcGUoXHJcbiAgICBtYXAoZW50aXRpZXMgPT4gKGlzVW5kZWZpbmVkKGVudGl0aWVzKSA/IHt9IDogZW50aXRpZXMpKSxcclxuICAgIGZpbHRlcjxPYmplY3RFeHRlbnNpb25zLkVudGl0aWVzPihCb29sZWFuKSxcclxuICAgIHRha2UoMSksXHJcbiAgKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG1hcEVudGl0aWVzVG9Db250cmlidXRvcnM8VCA9IGFueT4oc3RvcmU6IFN0b3JlLCByZXNvdXJjZTogc3RyaW5nKSB7XHJcbiAgcmV0dXJuIHBpcGUoXHJcbiAgICBzd2l0Y2hNYXAoZW50aXRpZXMgPT5cclxuICAgICAgemlwKHN0b3JlLnNlbGVjdChzZWxlY3RMb2NhbGl6YXRpb24pLCBzdG9yZS5zZWxlY3Qoc2VsZWN0RW51bXMpKS5waXBlKFxyXG4gICAgICAgIG1hcCgoW2xvY2FsaXphdGlvbiwgZW51bXNdKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBnZW5lcmF0ZURpc3BsYXlOYW1lID0gY3JlYXRlRGlzcGxheU5hbWVMb2NhbGl6YXRpb25QaXBlS2V5R2VuZXJhdG9yKGxvY2FsaXphdGlvbik7XHJcblxyXG4gICAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGVudGl0aWVzKS5yZWR1Y2UoXHJcbiAgICAgICAgICAgIChhY2MsIGtleToga2V5b2YgT2JqZWN0RXh0ZW5zaW9ucy5FbnRpdGllcykgPT4ge1xyXG4gICAgICAgICAgICAgIGFjYy5wcm9wW2tleV0gPSBbXTtcclxuICAgICAgICAgICAgICBhY2MuY3JlYXRlRm9ybVtrZXldID0gW107XHJcbiAgICAgICAgICAgICAgYWNjLmVkaXRGb3JtW2tleV0gPSBbXTtcclxuXHJcbiAgICAgICAgICAgICAgY29uc3QgZW50aXR5OiBPYmplY3RFeHRlbnNpb25zLkVudGl0eSA9IGVudGl0aWVzW2tleV07XHJcbiAgICAgICAgICAgICAgaWYgKCFlbnRpdHkpIHJldHVybiBhY2M7XHJcblxyXG4gICAgICAgICAgICAgIGNvbnN0IHByb3BlcnRpZXMgPSBlbnRpdHkucHJvcGVydGllcztcclxuICAgICAgICAgICAgICBpZiAoIXByb3BlcnRpZXMpIHJldHVybiBhY2M7XHJcblxyXG4gICAgICAgICAgICAgIGNvbnN0IG1hcFByb3BlcnRpZXNUb0NvbnRyaWJ1dG9ycyA9IGNyZWF0ZVByb3BlcnRpZXNUb0NvbnRyaWJ1dG9yc01hcHBlcjxUPihcclxuICAgICAgICAgICAgICAgIGdlbmVyYXRlRGlzcGxheU5hbWUsXHJcbiAgICAgICAgICAgICAgICByZXNvdXJjZSxcclxuICAgICAgICAgICAgICAgIGVudW1zLFxyXG4gICAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICAgIHJldHVybiBtYXBQcm9wZXJ0aWVzVG9Db250cmlidXRvcnMocHJvcGVydGllcywgYWNjLCBrZXkpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgcHJvcDoge30sXHJcbiAgICAgICAgICAgICAgY3JlYXRlRm9ybToge30sXHJcbiAgICAgICAgICAgICAgZWRpdEZvcm06IHt9LFxyXG4gICAgICAgICAgICB9IGFzIE9iamVjdEV4dGVuc2lvbnMuUHJvcENvbnRyaWJ1dG9ycyxcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfSksXHJcbiAgICAgICksXHJcbiAgICApLFxyXG4gICAgdGFrZSgxKSxcclxuICApO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjcmVhdGVQcm9wZXJ0aWVzVG9Db250cmlidXRvcnNNYXBwZXI8VCA9IGFueT4oXHJcbiAgZ2VuZXJhdGVEaXNwbGF5TmFtZTogRGlzcGxheU5hbWVHZW5lcmF0b3JGbixcclxuICByZXNvdXJjZTogc3RyaW5nLFxyXG4gIGVudW1zOiBSZWNvcmQ8c3RyaW5nLCBPYmplY3RFeHRlbnNpb25zLkVudW0+LFxyXG4pIHtcclxuICByZXR1cm4gKFxyXG4gICAgcHJvcGVydGllczogUmVjb3JkPHN0cmluZywgT2JqZWN0RXh0ZW5zaW9ucy5Qcm9wZXJ0eT4sXHJcbiAgICBjb250cmlidXRvcnM6IE9iamVjdEV4dGVuc2lvbnMuUHJvcENvbnRyaWJ1dG9yczxUPixcclxuICAgIGtleTogc3RyaW5nLFxyXG4gICkgPT4ge1xyXG4gICAgY29uc3QgaXNFeHRyYSA9IHRydWU7XHJcblxyXG4gICAgT2JqZWN0LmtleXMocHJvcGVydGllcykuZm9yRWFjaCgobmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IHByb3BlcnR5ID0gcHJvcGVydGllc1tuYW1lXTtcclxuICAgICAgY29uc3QgdHlwZSA9IGdldFR5cGVGcm9tUHJvcGVydHkocHJvcGVydHkpO1xyXG4gICAgICBjb25zdCBkaXNwbGF5TmFtZSA9IGdlbmVyYXRlRGlzcGxheU5hbWUocHJvcGVydHkuZGlzcGxheU5hbWUsIHsgbmFtZSwgcmVzb3VyY2UgfSk7XHJcblxyXG4gICAgICBpZiAocHJvcGVydHkudWkub25UYWJsZS5pc1Zpc2libGUpIHtcclxuICAgICAgICBjb25zdCBzb3J0YWJsZSA9IEJvb2xlYW4ocHJvcGVydHkudWkub25UYWJsZS5pc1NvcnRhYmxlKTtcclxuICAgICAgICBjb25zdCBjb2x1bW5XaWR0aCA9IHR5cGUgPT09IGVQcm9wVHlwZS5Cb29sZWFuID8gMTUwIDogMjUwO1xyXG4gICAgICAgIGNvbnN0IHZhbHVlUmVzb2x2ZXIgPVxyXG4gICAgICAgICAgdHlwZSA9PT0gZVByb3BUeXBlLkVudW1cclxuICAgICAgICAgICAgPyBjcmVhdGVFbnVtVmFsdWVSZXNvbHZlcihwcm9wZXJ0eS50eXBlLCBlbnVtc1twcm9wZXJ0eS50eXBlXSwgbmFtZSlcclxuICAgICAgICAgICAgOiBjcmVhdGVFeHRyYVByb3BlcnR5VmFsdWVSZXNvbHZlcjxUPihuYW1lKTtcclxuXHJcbiAgICAgICAgY29uc3QgZW50aXR5UHJvcCA9IG5ldyBFbnRpdHlQcm9wPFQ+KHtcclxuICAgICAgICAgIHR5cGUsXHJcbiAgICAgICAgICBuYW1lLFxyXG4gICAgICAgICAgZGlzcGxheU5hbWUsXHJcbiAgICAgICAgICBzb3J0YWJsZSxcclxuICAgICAgICAgIGNvbHVtbldpZHRoLFxyXG4gICAgICAgICAgdmFsdWVSZXNvbHZlcixcclxuICAgICAgICAgIGlzRXh0cmEsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNvbnRyaWJ1dG9yID0gKHByb3BMaXN0OiBFbnRpdHlQcm9wTGlzdDxUPikgPT4gcHJvcExpc3QuYWRkVGFpbChlbnRpdHlQcm9wKTtcclxuICAgICAgICBjb250cmlidXRvcnMucHJvcFtrZXldLnB1c2goY29udHJpYnV0b3IpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBpc09uQ3JlYXRlRm9ybSA9IHByb3BlcnR5LnVpLm9uQ3JlYXRlRm9ybS5pc1Zpc2libGU7XHJcbiAgICAgIGNvbnN0IGlzT25FZGl0Rm9ybSA9IHByb3BlcnR5LnVpLm9uRWRpdEZvcm0uaXNWaXNpYmxlO1xyXG5cclxuICAgICAgaWYgKGlzT25DcmVhdGVGb3JtIHx8IGlzT25FZGl0Rm9ybSkge1xyXG4gICAgICAgIGNvbnN0IGRlZmF1bHRWYWx1ZSA9IHByb3BlcnR5LmRlZmF1bHRWYWx1ZTtcclxuICAgICAgICBjb25zdCB2YWxpZGF0b3JzID0gKCkgPT4gZ2V0VmFsaWRhdG9yc0Zyb21Qcm9wZXJ0eShwcm9wZXJ0eSk7XHJcbiAgICAgICAgbGV0IG9wdGlvbnM6IFByb3BDYWxsYmFjazxhbnksIE9ic2VydmFibGU8QUJQLk9wdGlvbjxhbnk+W10+PjtcclxuICAgICAgICBpZiAodHlwZSA9PT0gZVByb3BUeXBlLkVudW0pIG9wdGlvbnMgPSBjcmVhdGVFbnVtT3B0aW9ucyhuYW1lLCBlbnVtc1twcm9wZXJ0eS50eXBlXSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGZvcm1Qcm9wID0gbmV3IEZvcm1Qcm9wKHtcclxuICAgICAgICAgIHR5cGUsXHJcbiAgICAgICAgICBuYW1lLFxyXG4gICAgICAgICAgZGlzcGxheU5hbWUsXHJcbiAgICAgICAgICBvcHRpb25zLFxyXG4gICAgICAgICAgZGVmYXVsdFZhbHVlLFxyXG4gICAgICAgICAgdmFsaWRhdG9ycyxcclxuICAgICAgICAgIGlzRXh0cmEsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGZvcm1Db250cmlidXRvciA9IChwcm9wTGlzdDogRm9ybVByb3BMaXN0PFQ+KSA9PiBwcm9wTGlzdC5hZGRUYWlsKGZvcm1Qcm9wKTtcclxuXHJcbiAgICAgICAgaWYgKGlzT25DcmVhdGVGb3JtKSBjb250cmlidXRvcnMuY3JlYXRlRm9ybVtrZXldLnB1c2goZm9ybUNvbnRyaWJ1dG9yKTtcclxuICAgICAgICBpZiAoaXNPbkVkaXRGb3JtKSBjb250cmlidXRvcnMuZWRpdEZvcm1ba2V5XS5wdXNoKGZvcm1Db250cmlidXRvcik7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBjb250cmlidXRvcnM7XHJcbiAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0VHlwZUZyb21Qcm9wZXJ0eShwcm9wZXJ0eTogT2JqZWN0RXh0ZW5zaW9ucy5Qcm9wZXJ0eSk6IGVQcm9wVHlwZSB7XHJcbiAgcmV0dXJuIChwcm9wZXJ0eS50eXBlU2ltcGxlLnJlcGxhY2UoL1xcPyQvLCAnJykgYXMgc3RyaW5nKSBhcyBlUHJvcFR5cGU7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzVW5kZWZpbmVkKG9iajogYW55KTogb2JqIGlzIHVuZGVmaW5lZCB7XHJcbiAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICd1bmRlZmluZWQnO1xyXG59XHJcblxyXG50eXBlIERpc3BsYXlOYW1lR2VuZXJhdG9yRm4gPSBSZXR1cm5UeXBlPHR5cGVvZiBjcmVhdGVEaXNwbGF5TmFtZUxvY2FsaXphdGlvblBpcGVLZXlHZW5lcmF0b3I+O1xyXG50eXBlIE1vZHVsZUtleSA9IGtleW9mIE9iamVjdEV4dGVuc2lvbnMuTW9kdWxlcztcclxuIl19